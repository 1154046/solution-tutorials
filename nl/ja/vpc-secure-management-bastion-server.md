---
copyright:
  years: 2019
lastupdated: "2019-04-02"

---

{:java: #java .ph data-hd-programlang='java'}
{:swift: #swift .ph data-hd-programlang='swift'}
{:ios: #ios data-hd-operatingsystem="ios"}
{:android: #android data-hd-operatingsystem="android"}
{:shortdesc: .shortdesc}
{:new_window: target="_blank"}
{:codeblock: .codeblock}
{:screen: .screen}
{:tip: .tip}
{:pre: .pre}
{:important: .important}

# 要塞ホストを使用してリモート・インスタンスにセキュアにアクセスする
{: #vpc-secure-management-bastion-server}

IBM は、2019 年 4 月上旬に開始する VPC の早期アクセス・プログラムでは、参加を受け付けるお客様の数を限定しますが、数カ月後に利用者数を拡大する予定です。 IBM 仮想プライベート・クラウドの利用をご希望のお客様は、こちらの[応募フォーム](https://{DomainName}/vpc){: new_window} にご記入ください。IBM 担当員から次のステップについてお知らせいたします。
{: important}

このチュートリアルでは、仮想プライベート・クラウド内のリモート・インスタンスにセキュアにアクセスするために要塞ホストをデプロイする手順について説明します。要塞ホストは、パブリック・サブネットにプロビジョンされ、SSH を使用してアクセスできるインスタンスです。一度セットアップすると、要塞ホストは、プライベート・サブネットにプロビジョンしたインスタンスに安全に接続するための**踏み台**サーバーとして機能します。

VPC 内のサーバーの露見を減らすために、要塞ホストを作成して使用します。個々のサーバーに対する管理用タスクを、SSH を使用して、要塞を介して実行します。サーバーへのアクセスおよびサーバーからの通常のインターネット・アクセス (例えば、ソフトウェアのインストールのためなど) は、それらのサーバーに特別な保守セキュリティー・グループが関連付けられている場合にのみ許可されます。
{:shortdesc}

## 達成目標
{: #objectives}

* 要塞ホストと、ルールを指定したセキュリティー・グループをセットアップする方法を学ぶ。
* 要塞ホストを介してサーバーをセキュアに管理する。

## 使用するサービス
{: #services}

このチュートリアルでは、以下のランタイムとサービスを使用します。  

- [{{site.data.keyword.vpc_full}}](https://{DomainName}/vpc/provision/vpc)  
- [{{site.data.keyword.vsi_is_full}}](https://{DomainName}/vpc/provision/vs)

このチュートリアルでは、費用が発生する場合があります。[料金カリキュレーター](https://{DomainName}/pricing/)を使用して、使用見積もりに基づいてコスト見積もりを生成してください。

## アーキテクチャー
{: #architecture}

  ![アーキテクチャー](images/solution47-vpc-secure-management-bastion-server/ArchitectureDiagram.png)

1. クラウド上に必要なインフラストラクチャー (サブネット、ルールを指定したセキュリティー・グループ、VSI) をセットアップした後、管理者 (DevOps)が秘密 SSH 鍵を使用して要塞ホストに接続 (SSH) します。
2. 管理者が保守セキュリティー・グループに適切なアウトバウンド・ルールを割り当てます。
3. 管理者が要塞ホストを介してインスタンスのプライベート IP アドレスにセキュアに接続 (SSH) し、必要なソフトウェア (Web サーバーなど) をインストールまたは更新します。
4. インターネット・ユーザーが Web サーバーに HTTP/HTTPS 要求を送信します。

## 始める前に
{: #prereqs}

- ユーザー許可を確認してください。VPC リソースを作成および管理するための十分な許可がユーザー・アカウントに付与されていることを確認してください。必要な許可のリストについては、[VPC ユーザーに必要な許可の付与](/docs/infrastructure/vpc?topic=vpc-managing-user-permissions-for-vpc-resources#managing-user-permissions-for-vpc-resources)を参照してください。
- 仮想サーバーに接続するには SSH 鍵が必要です。SSH 鍵がない場合は、[鍵の作成手順](/docs/infrastructure/vpc?topic=vpc-getting-started-with-ibm-cloud-virtual-private-cloud-infrastructure#prerequisites)を参照してください。
- このチュートリアルでは、既存の[仮想プライベート・クラウド](https://{DomainName}/vpc/network/vpcs)に要塞ホストを追加します。**アカウントに仮想プライベート・クラウドがない場合は、次の手順に進む前に作成してください。**

## 要塞ホストを作成する
{: #create-bastion-host}

このセクションでは、独立した 1 つのサブネット内に要塞ホストとセキュリティー・グループを作成して構成します。

### サブネットを作成する
{: #create-bastion-subnet}

1. 左側のペインの**「ネットワーク」**にある**「サブネット」**をクリックし、**「新規サブネット」**をクリックします。  
   * 名前に **vpc-secure-bastion-subnet** と入力してから、作成した VPC を選択します。  
   * ロケーションとゾーンを選択します。  
   * サブネットの IP 範囲を CIDR 表記で入力します (つまり、**10.xxx.0.0/24** のように入力します)。**「アドレス接頭部」**はそのままにして、**「アドレスの数」**として 256 を選択します。
1. サブネット・アクセス制御リスト (ACL) には**「VPC デフォルト」**を選択します。インバウンド・ルールとアウトバウンド・ルールは後で設定できます。
1. **「パブリック・ゲートウェイ」**を**「接続済み」**に切り替えます。 
1. **「サブネットの作成」**をクリックしてサブネットをプロビジョンします。

### 要塞セキュリティー・グループを作成して構成する

セキュリティー・グループを作成し、要塞 VSI へのインバウンド・ルールを構成しましょう。

1. **「セキュリティー・グループ」**に移動して、**「新規セキュリティー・グループ」**をクリックします。名前に **vpc-secure-bastion-sg** と入力し、VPC を選択します。 
2. ここで、インバウンド・セクションの**「ルールの追加」**をクリックして、以下のインバウンド・ルールを作成します。SSH アクセスと ping (ICMP) を許可するルールです。
 
	**インバウンド・ルール:**
	<table>
	   <thead>
	      <tr>
	         <td><strong> ソース </strong></td>
	         <td><strong> プロトコル </strong></td>
	         <td><strong>値</strong></td>
	      </tr>
	   <tbody>
	      <tr>
	         <td>すべて - 0.0.0.0/0</td>
	         <td>TCP</td>
	         <td><strong>22</strong> から <strong>22</strong> まで</td>
	      </tr>
         <tr>
            <td>すべて - 0.0.0.0/0</td>
	         <td>ICMP</td>
	         <td>タイプ: <strong>8</strong>、コード: <strong>空のままにする</strong></td>
         </tr>
	   </tbody>
	</table>

   さらにセキュリティーを強化するために、インバウンド・トラフィックを会社のネットワークまたは一般的なホーム・ネットワークに制限することができます。`curl ipecho.net/plain ; echo` を実行して、ネットワークの外部 IP アドレスを取得し、代わりにそれを使用できます。{:tip }

### 要塞インスタンスを作成する
サブネットとセキュリティー・グループの準備が完了したら、次は、要塞仮想サーバー・インスタンスを作成します。

1. 左側のペインの**「サブネット」**で **vpc-secure-bastion-subnet** を選択します。
2. **「接続済みインスタンス」**をクリックし、独自の VPC で **vpc-secure-vsi** という名前の**新規インスタンス**をプロビジョンします。イメージとして Ubuntu Linux を選択し、プロファイルとして **c-2x4** (vCPU 2 つと RAM 4 GB) を選択します。
3. **ロケーション**を選択します。必ず、後でこの同じロケーションをもう一度使用してください。
4. **SSH 鍵**を新規作成するには、**「新規鍵」**をクリックします。
   * 鍵の名前として **vpc-ssh-key** と入力します。
   * **「地域 (Region)」**はそのままにします。
   * 既存のローカル SSH 鍵の内容をコピーして、**「公開鍵」**に貼り付けます。  
   * **「SSH 鍵の追加」**をクリックします。
5. **「ネットワーク・インターフェース」**で、セキュリティー・グループの横にある**「編集」**アイコンをクリックします。 
   * サブネットとして **vpc-secure-subnet** が選択されていることを確認します。
   * デフォルトのセキュリティー・グループのチェック・マークを外し、**vpc-secure-bastion-sg** にチェック・マークを付けます。
   * **「保存」**をクリックします。
6. **「仮想サーバー・インスタンスの作成 (Create virtual server instance)」**をクリックします。
7. インスタンスの電源が入ったら、**vpc-secure-bastion-vsi** をクリックして浮動 IP を**予約**します。

### 要塞をテストする

要塞の浮動 IP アドレスがアクティブになったら、**ssh** を使用して接続してみてください。

   ```sh
   ssh -i ~/.ssh/<PRIVATE_KEY> root@<BASTION_FLOATING_IP_ADDRESS>
   ```
   {:pre}

## 保守アクセス・ルールを指定してセキュリティー・グループを構成する
{: #maintenance-security-group}

要塞に正常にアクセスできたら、ソフトウェアのインストールや更新などの保守タスクのためにセキュリティー・グループの作成に進みます。

1. **「セキュリティー・グループ」**に移動し、以下のアウトバウンド・ルールを指定して **vpc-secure-maintenance-sg**という新しいセキュリティー・グループをプロビジョンします。

   <table>
   <thead>
      <tr>
         <td><strong> 宛先 </strong></td>
         <td><strong> プロトコル </strong></td>
         <td><strong>値</strong> </td>
      </tr>
   </thead>
   <tbody>
      <tr>
         <td>すべて - 0.0.0.0/0</td>
         <td>TCP</td>
         <td><strong>80</strong> から <strong>80</strong> まで</td>
      </tr>
      <tr>
         <td>すべて - 0.0.0.0/0</td>
         <td>TCP</td>
         <td><strong>443</strong> から <strong>443</strong> まで</td>
      </tr>
       <tr>
         <td>すべて - 0.0.0.0/0</td>
         <td>TCP</td>
         <td><strong>53</strong> から <strong>53</strong> まで</td>
      </tr>
      <tr>
         <td>すべて - 0.0.0.0/0</td>
         <td>UDP</td>
         <td><strong>53</strong> から <strong>53</strong> まで</td>
      </tr>
   </tbody>
   </table>

   DNS サーバーの要求はポート 53 に送られます。DNS は、ゾーン転送に TCP を使用し、正引き (プライマリー) と逆引きの両方の名前照会に UDP を使用します。HTTP 要求はポート 80 と 443 に送られます。{:tip }

2. 次に、要塞ホストからの SSH アクセスを許可するこの**インバウンド**・ルールを追加します。

   <table>
	   <thead>
	      <tr>
	         <td><strong> ソース </strong></td>
	         <td><strong> プロトコル </strong></td>
	         <td><strong>値</strong> </td>
	      </tr>
	   </thead>
	   <tbody>
	     <tr>
	         <td>タイプ: <strong>セキュリティー・グループ</strong> - 名前: <strong>vpc-secure-bastion-sg</strong></td>
	         <td>TCP</td>
	         <td><strong>22</strong> から <strong>22</strong> まで</td>
	      </tr>
	   </tbody>
	</table>

3. セキュリティー・グループを作成します。
4. **「VPC のすべてのセキュリティー・グループ (All Security Groups for VPC)」**に移動して、**vpc-secure-sg** を選択します。
5. 最後に、セキュリティー・グループを編集して、次の**アウトバウンド**・ルールを追加します。

   <table>
	   <thead>
	      <tr>
	         <td><strong> 宛先 </strong></td>
	         <td><strong> プロトコル </strong></td>
	         <td><strong>値</strong> </td>
	      </tr>
	   </thead>
	   <tbody>
	     <tr>
	         <td>タイプ: <strong>セキュリティー・グループ</strong> - 名前: <strong>vpc-secure-maintenance-sg</strong></td>
	         <td>TCP</td>
	         <td><strong>22</strong> から <strong>22</strong> まで</td>
	      </tr>
	   </tbody>
	</table>


## 要塞ホストを使用して VPC 内の他のインスタンスにアクセスする
{: #bastion-host-access-instances}

このセクションでは、プライベート・サブネットと仮想サーバー・インスタンスおよびセキュリティー・グループを作成します。デフォルトでは、VPC 内に作成したサブネットはすべてプライベートです。

接続先の VPC に仮想サーバー・インスタンスが既にある場合は、次の 3 つのセクションをスキップして、[仮想サーバー・インスタンスを保守セキュリティー・グループに追加する](#add-vsi-to-maintenance)手順に進むことができます。

### サブネットを作成する
{: #create-private-subnet}

サブネットを新規作成するには、次のようにします。

1. 左側のペインの**「ネットワーク」**にある**「サブネット」**をクリックし、**「新規サブネット」**をクリックします。  
   * 名前に **vpc-secure-private-subnet** と入力してから、作成した VPC を選択します。  
   * ロケーションを選択します。  
   * サブネットの IP 範囲を CIDR 表記で入力します (つまり、**10.xxx.1.0/24** のように入力します)。**「アドレス接頭部」**はそのままにして、**「アドレスの数」**として 256 を選択します。
1. サブネット・アクセス制御リスト (ACL) には**「VPC デフォルト」**を選択します。インバウンド・ルールとアウトバウンド・ルールは後で設定できます。
1. **「パブリック・ゲートウェイ」**を**「接続済み」**に切り替えます。 
1. **「サブネットの作成」**をクリックしてサブネットをプロビジョンします。

### セキュリティー・グループを作成します

セキュリティー・グループを新規作成するには、次のようにします。  
1. 「ネットワーク」の**「セキュリティー・グループ」**をクリックしてから、**「新規セキュリティー・グループ」**をクリックします。  
2. 名前に **vpc-secure-private-sg** としてから、前に作成した VPC を選択します。   
3. **「セキュリティー・グループの作成」**をクリックします。  

### 仮想サーバー・インスタンスを作成する

新規に作成されたサブネットで仮想サーバー・インスタンスを作成するには、以下のようにします。

1. **「サブネット」**でプライベート・サブネットをクリックします。
2. **「接続済みインスタンス」**をクリックしてから、**「新規インスタンス」**をクリックします。
3. 固有の名前 **vpc-secure-private-vsi** を入力し、前に作成した VPC を選択してから、前と同じ**「ロケーション」**を選択します。
4. **Ubuntu Linux** イメージを選択し、**「すべてのプロファイル」**をクリックして、**「コンピュート」**で **c-2x4** (vCPU 2 つと RAM 4 GB) を選択します。
5. **「SSH 鍵」**で、要塞用に前に作成した SSH 鍵を選択します。
6. **「ネットワーク・インターフェース」**で、セキュリティー・グループの横にある**「編集」**アイコンをクリックします。   
   * サブネットとして **vpc-secure-private-subnet** を選択します。  
   * デフォルトのセキュリティーとグループのチェック・マークを外し、**vpc-secure-private-sg** をアクティブにします。  
   * **「保存」**をクリックします。  
7. **「仮想サーバー・インスタンスの作成 (Create virtual server instance)」**をクリックします。  


### 保守セキュリティー・グループに仮想サーバーを追加する
{: #add-vsi-to-maintenance}

サーバー上で管理作業を行うには、特定の仮想サーバーを保守セキュリティー・グループに関連付ける必要があります。以下では、保守を有効にしてプライベート・サーバーにログインし、ソフトウェア・パッケージ情報を更新してから、セキュリティー・グループの関連付けを解除します。

サーバーの保守セキュリティー・グループを有効にしましょう。

1. **「セキュリティー・グループ」**に移動し、**vpc-secure-maintenance-sg** セキュリティー・グループを選択します。  
2. **「接続済みインターフェース」**をクリックしてから、**「インターフェースの編集」**をクリックします。  
3. 仮想サーバー・インスタンスを展開し、**「インターフェース」**列で**「プライマリー (primary)」**の横にある選択をアクティブにします。
4. **「保存」**をクリックして、変更を適用します。

### インスタンスに接続する

**プライベート IP** を使用してインスタンスに SSH 接続するには、要塞ホストを**踏み台ホスト**として使用します。

1. **「仮想サーバー・インスタンス」**で仮想サーバー・インスタンスのプライベート IP アドレスを取得します。
2. ssh コマンドに `-J` を付けて使用して、前に使用した要塞の**浮動 IP** アドレスと、**「ネットワーク・インターフェース」**に表示されているサーバーの**「プライベート IP」**アドレスを指定してサーバーにログインします。

   ```sh
   ssh -J root@<BASTION_FLOATING_IP_ADDRESS> root@<PRIVATE_IP_ADDRESS>
   ```
   {:pre}
   
   `-J` フラグは OpenSSH バージョン 7.3 以降でサポートされています。それより古いバージョンでは、`-J` は使用できません。その場合は、最も安全で単純な方法として、ssh の stdio 転送 (`-W`) モードを使用して、要塞ホストを介して接続を「バウンス」できます。例: `ssh -o ProxyCommand="ssh -W %h:%p root@<BASTION_FLOATING_IP_ADDRESS" root@<PRIVATE_IP_ADDRESS>`
   {:tip }

### ソフトウェアをインストールして保守タスクを実行する

接続したら、プライベート・サブネット内の仮想サーバーにソフトウェアをインストールしたり、保守タスクを実行したりできます。

1. まずは、ソフトウェア・パッケージ情報を更新します。
   ```sh
   apt-get update
   ```
   {:pre}
2. 目的のソフトウェア (Nginx、MySQL、IBM Db2 など) をインストールします。

完了したら、`exit` コマンドを使用してサーバーから切断します。 

インターネット・ユーザーからの HTTP/HTTPS 要求を許可するには、プライベート・サブネットの VSI に**浮動 IP** を割り当て、プライベート VSI のセキュリティー・グループ内のインバウンド・ルールを介して必要なポート (HTTP 用は 80 および HTTPS 用は 443) を開きます。
{:tip}

### 保守セキュリティー・グループを無効にする

ソフトウェアのインストールまたは保守が完了したら、仮想サーバーを保守セキュリティー・グループから外して分離します。

1. **「セキュリティー・グループ」**に移動し、**vpc-secure-maintenance-sg** セキュリティー・グループを選択します。  
2. **「接続済みインターフェース」**をクリックしてから、**「インターフェースの編集」**をクリックします。  
3. 仮想サーバー・インスタンスを展開し、**「インターフェース」**列で**「プライマリー (primary)」**の横にあるチェック・マークを外します。
4. **「保存」**をクリックして、変更を適用します。

## リソースの削除
{: #removeresources}

1. **「仮想サーバー・インスタンス」**に切り替えてインスタンスを**「削除」**します。インスタンスが削除され、しばらくの間、ステータスに**「削除中」**と表示されます。時々ブラウザーを最新表示するようにしてください。
2. VSI が表示されなくなったら、**「サブネット」**に切り替えてサブネットを削除します。
4. サブネットが削除されたら、**「仮想プライベート・クラウド」**タブに切り替えて VPC を削除します。

コンソールの使用時、リソース削除後の更新された状況情報を確認するためには、ブラウザーを最新表示しなければならない場合があります。
{:tip}

## 関連コンテンツ
{: #related}

* [仮想プライベート・クラウド内のプライベート・サブネットとパブリック・サブネット](/docs/tutorials?topic=solution-tutorials-vpc-public-app-private-backend#vpc-public-app-private-backend)
