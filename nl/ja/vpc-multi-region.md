---
copyright:
  years: 2019
lastupdated: "2019-04-02"
---

{:java: #java .ph data-hd-programlang='java'}
{:swift: #swift .ph data-hd-programlang='swift'}
{:ios: #ios data-hd-operatingsystem="ios"}
{:android: #android data-hd-operatingsystem="android"}
{:shortdesc: .shortdesc}
{:new_window: target="_blank"}
{:codeblock: .codeblock}
{:screen: .screen}
{:tip: .tip}
{:pre: .pre}
{:important: .important}

#                 複数の場所およびゾーンにわたる分離されたワークロードのデプロイ
            
{: #vpc-multi-region}

IBM は、2019 年 4 月上旬に開始する VPC の早期アクセス・プログラムでは、参加を受け付けるお客様の数を限定しますが、数カ月後に利用者数を拡大する予定です。 IBM 仮想プライベート・クラウドの利用をご希望のお客様は、こちらの[応募フォーム](https://{DomainName}/vpc){: new_window} にご記入ください。IBM 担当員から次のステップについてお知らせいたします。
{: important}

このチュートリアルでは、さまざまな IBM Cloud 地域に VPC をプロビジョンすることによって、分離されたワークロードをセットアップする手順について説明します。各地域にはサブネットと仮想サーバー・インスタンス (VSI) が作成されます。これらの VSI は、地域内の複数のゾーンに作成され、バックエンド・プール、フロントエンド・リスナー、および適切なヘルス・チェックを使用してロード・バランサーを構成することによって、地域内およびグローバルに耐障害性を強化します。

グローバル・ロード・バランサーでは、カタログから IBM Cloud Internet Services (CIS) サービスをプロビジョンします。また、すべての着信 HTTPS 要求の SSL 証明書を管理するために、{{site.data.keyword.cloudcerts_long_notm}} カタログ・サービスが作成され、証明書が秘密鍵とともにインポートされます。

{:shortdesc}

## 達成目標
{: #objectives}

* 仮想プライベート・クラウドで使用可能なインフラストラクチャー・オブジェクトを使用したワークロードの分離について理解する。
* 地域内のゾーン間でロード・バランサーを使用して、仮想サーバー間でトラフィックを分散する。
* 地域間でグローバル・ロード・バランサーを使用して、耐障害性の強化および待ち時間の短縮を図る。

## 使用するサービス
{: #services}

このチュートリアルでは、以下のランタイムとサービスを使用します。

- [{{site.data.keyword.vpc_full}}](https://{DomainName}/vpc/provision/vpc)
- [{{site.data.keyword.vsi_is_full}}](https://{DomainName}/vpc/provision/vs)
- [{{site.data.keyword.loadbalancer_full}}](https://{DomainName}/vpc/provision/loadBalancer)
- IBM Cloud [Internet Services](https://{DomainName}/catalog/services/internet-services)
- [{{site.data.keyword.cloudcerts_long_notm}}](https://{DomainName}/catalog/services/cloudcerts)

このチュートリアルでは、費用が発生する場合があります。[料金カリキュレーター](https://{DomainName}/estimator/review)を使用して、使用見積もりに基づいてコスト見積もりを生成してください。

## アーキテクチャー
{: #architecture}

  ![アーキテクチャー](images/solution41-vpc-multi-region/Architecture.png)

1. 管理者 (DevOps) は、地域 1 の VPC 内の 2 つの異なるゾーンにあるサブネットに VSI をプロビジョンし、地域 2 で作成された VPC で同じ手順を繰り返します。
2. 管理者は、地域 1 の異なるゾーン内のサブネットにあるサーバーのバックエンド・プールとフロントエンド・リスナーを使用してロード・バランサーを作成します。地域 2 で同じ手順を繰り返します。
3. 管理者は、関連するカスタム・ドメインを持つクラウド・インターネット・サービスをプロビジョンし、2 つの異なる VPC に作成されたロード・バランサーを指すグローバル・ロード・バランサーを作成します。
4. 管理者は、ドメインの SSL 証明書を Certificate Manager サービスに追加することによって HTTPS 暗号化を有効にします。
5. インターネット・ユーザーが HTTP/HTTPS 要求を作成し、グローバル・ロード・バランサーがその要求を処理します。
6. 要求は、グローバルとローカルの両方のロード・バランサーにルーティングされます。その後、その要求は使用可能なサーバー・インスタンスによって実行されます。

## 始める前に
{: #prereqs}

- ユーザー許可を確認してください。VPC リソースを作成および管理するための十分な許可がユーザー・アカウントに付与されていることを確認してください。必要な許可のリストについては、[VPC ユーザーに必要な許可の付与](/docs/infrastructure/vpc?topic=vpc-managing-user-permissions-for-vpc-resources#managing-user-permissions-for-vpc-resources)を参照してください。
- 仮想サーバーに接続するには、SSH 鍵が必要です。SSH 鍵がない場合は、[鍵の作成手順](/docs/infrastructure/vpc?topic=vpc-getting-started-with-ibm-cloud-virtual-private-cloud-infrastructure#prerequisites)を参照してください。
- Cloud Internet Services を使用するには、カスタム・ドメインを所有している必要があります。Cloud Internet Services のネーム・サーバーを参照するようにそのドメインの DNS を構成するためです。ドメインを所有していない場合、レジストラー ([godaddy.com](http://godaddy.com/) など) から購入できます。

## VPC、サブネット、および VSI を作成する
{: #create-infrastructure}

このセクションでは、地域 1 の 2 つの異なるゾーンに作成したサブネットを使用して地域 1 に独自の VPC を作成してから、VSI をプロビジョンします。

地域 1 に独自の {{site.data.keyword.vpc_short}} を作成するには、次のようにします。

1. [「VPC の概要 (VPC overview)」](https://{DomainName}/vpc/overview)ページに移動して、**「VPC を作成します」**をクリックします。
2. **「新規仮想プライベート・クラウド」**セクションで、以下のようにします。
   * VPC の名前として **vpc-region1** と入力します。
   * **「リソース・グループ」**を選択します。
   * オプションで、**「タグ」**を追加してリソースを編成します。
3. VPC のデフォルト・アクセス制御リスト (ACL) として、**「新規デフォルトの作成 (すべて許可)」**を選択します。
4. SSH のチェック・マークを外して、**「デフォルトのセキュリティー・グループ」**から ping し、**「クラシック・アクセス」**のチェック・マークを外したままにします。
5. **「VPC 用の新規サブネット」**で、以下のようにします。
   * 固有の名前として、**vpc-region1-zone1-subnet** と入力します。
   * 場所 (例えば、「ダラス」) を選択し、これを**「地域 1」**と呼び、地域 1 のゾーン (例えば、「ダラス 1」) を選択して**「ゾーン 1」**と呼びます
   * サブネットの IP 範囲を CIDR 表記で入力します (つまり、**10.xxx.0.0/24** のように入力します)。**「アドレス接頭部」**はそのままにして、**「アドレスの数」**として 256 を選択します。
6. サブネットのアクセス制御リスト (ACL) に**「VPC デフォルトの使用」**を選択します。インバウンド・ルールとアウトバウンド・ルールは後で設定できます。
7. サブネット内のすべての仮想サーバー・インスタンスに浮動 IP が付加される場合は、サブネットのパブリック・ゲートウェイを使用可能にする必要はありません。仮想サーバー・インスタンスはそれぞれの浮動 IP でインターネットに接続します。
8. **「仮想プライベート・クラウドの作成 (Create virtual private cloud)」**をクリックして、インスタンスをプロビジョンします。

サブネットの作成を確認するには、左側のペインの**「サブネット」**をクリックし、状況が**「使用可能」**に変わるまで待ちます。**「サブネット」**の下に新しいサブネットを作成できます。

### ゾーン 2 にサブネットを作成する

1. **「新規サブネット」**をクリックして、サブネットの固有の名前として **vpc-region1-zone2-subnet** と入力し、VPC に **vpc-region1** を選択します。
2. 上記で地域 1 と呼ぶことにした場所 (例えば、ダラス) を選択し、地域 1 内の異なるゾーン (例えば、ダラス 2) を選択して、選択したこのゾーンを**ゾーン 2** と呼びます。
3. サブネットの IP 範囲を CIDR 表記で入力します (つまり、**10.xxx.64.0/24** のように入力します)。**「アドレス接頭部」**はそのままにして、**「アドレスの数」**として 256 を選択します。
4. サブネットのアクセス制御リスト (ACL) に**「VPC デフォルトの使用」**を選択します。

### VSI をプロビジョンする
サブネットの状況が**「使用可能」**に変わったら、以下のようにします。

1. **「vpc-region1-zone1-subnet」**をクリックしてから、**「接続済みインスタンス」**、**「新規インスタンス」**の順にクリックします。
2. 固有の名前を入力して、**「vpc-region1-zone1-vsi」**を選択します。次に、上記で作成した VPC を選択し、前述の手順と同様に**ゾーン**とともに**場所**を選択します。
3. 任意の **Ubuntu Linux** イメージを選択し、**「すべてのプロファイル」**をクリックしてから、**「コンピュート」**の下で 2vCPU と 4 GB RAM を持つ **c-2x4** を選択します。
4. **「SSH 鍵」**で、最初に作成した SSH 鍵を選択します。
5. **「ネットワーク・インターフェース」**で、セキュリティー・グループの横にある**「編集」**アイコンをクリックします。
   * サブネットとして**「vpc-region1-zone1-subnet」**が選択されているかどうかを確認します。選択されていない場合は、選択します。
   * **「保存」**をクリックします。
   * **「仮想サーバー・インスタンスの作成 (Create virtual server instance)」**をクリックします。
6.  VSI の状況が**「電源オン」**に変わるまで待ちます。次に、VSI の**「vpc-region1-zone1-vsi」**を選択して、**「ネットワーク・インターフェース」**までスクロールし、**「浮動 IP」**で**「予約」**をクリックして、パブリック IP アドレスを当該 VSI に関連付けます。後で参照できるように、関連付けた IP アドレスをクリップボードに保存します。
7. ステップ 1 から 6 を**繰り返して**、VSI を **地域 1** の **ゾーン 2** にプロビジョンします。

左側のペインで**「ネットワーク」**の下の**「VPC」**および**「サブネット」**に移動して、上記のステップを**繰り返し**、**地域 2** のサブネットと VSI を使用して、上記と同じ命名規則に従って新規 VPC をプロビジョンします。

## VSI に Web サーバーをインストールして構成する
{: #install-configure-web-server-vsis}

`ジャンプ`・サーバーとして機能する要塞ホストと保守セキュリティー・グループを使用したサーバーのセキュアな保守を実施するために、[要塞ホストを使用してリモート・インスタンスにセキュアにアクセスする](/docs/tutorials?topic=solution-tutorials-vpc-secure-management-bastion-server)に記載されている手順に従います。
{:tip}

地域 1 のゾーン 1 のサブネットにプロビジョンされたサーバーに正常に SSH で接続したら、以下のようにします。

1. プロンプトに従って、以下のコマンドを実行して、Web サーバーとして Nginx をインストールします。
   ```
   sudo apt-get update
   sudo apt-get install nginx
   ```
   {:codeblock}
2. 次のコマンドを使用して、Nginx サービスの状況を確認します。
   ```
   sudo systemctl status nginx
   ```
   {:pre}
   出力に、Nginx サービスが**アクティブ**かつ稼働中であることが示されます。
3. トラフィック (要求) を受信するために、**HTTP (80)** と **HTTPS (443)** のポートを開く必要があります。これらのポートを開くには、[UFW](https://help.ubuntu.com/community/UFW) - `sudo ufw enable` を使用してファイアウォールを調整し、両方のポートのルールを含む「Nginx Full」プロファイルを有効にします。
   ```
   sudo ufw allow 'Nginx Full'
   ```
   {:pre}
4. Nginx が正常に機能していることを確認するには、任意のブラウザーで `http://FLOATING_IP` を開きます。デフォルトの Nginx ウェルカム・ページが表示されるはずです。
5. 地域とゾーンの詳細で HTML ページを更新するには、次のコマンドを実行します。
   ```
   nano /var/www/html/index.nginx-debian.html
   ```
   {:pre}
   地域とゾーン (例えば、_**地域 1 のゾーン 1** で実行されているサーバー_) を 「`Welcome to nginx!`」と記述されている `h1` タグに追加して、変更を保存します。
6. nginx サーバーを再始動して、変更内容を反映します。
   ```
   sudo systemctl restart nginx
   ```
   {:pre}

1 から 6 の手順を**繰り返して**、すべてのゾーンのサブネットの VSI 上に Web サーバーをインストールして構成します。必ず、それぞれのゾーン情報で HTML を更新してください。


## ロード・バランサーを使用してゾーン間でトラフィックを分散する
{: #distribute-traffic-with-load-balancers}

このセクションでは、2 つのロード・バランサーを作成します。それぞれの地域にロード・バランサーを 1 つ作成し、異なるゾーン内の各サブネットにある複数のサーバー・インスタンス間でトラフィックを分散します。

### ロード・バランサーを構成する

1. **「ロード・バランサー」**に移動して、**「新規ロード・バランサー」**をクリックします。
2. 固有の名前として**「vpc-lb-region1」**と指定して、仮想プライベート・クラウドに**「vpc-region1」**を選択し、続けて VPC が作成されたリソース・グループを選択します。ロード・バランサーのタイプに**「パブリック」**を指定し、地域として **「region1」**を選択します。
3. **地域 1** の **ゾーン 1** と**ゾーン 2** の両方のプライベート IP を選択します。
4. プールにルーティングされたトラフィックを共有する同等のピアとして機能する VSI の新しいバックエンド・プールを作成します。以下の値を使用してパラメーターを設定し、**「作成」**をクリックします。
	- **名前**: region1-pool
	- **プロトコル**: HTTP
	- **メソッド**: ラウンドロビン
	- **セッション維持率**: なし
	- **ヘルス・チェック・パス**: /
	- **ヘルス・プロトコル**: HTTP
	- **間隔 (秒)**: 15
	- **タイムアウト (秒)**: 2
	- **最大再試行回数**: 2
5. **「接続」**をクリックして、サーバー・インスタンスを region1-pool に追加します。
   - **vpc-region1-zone1-subnet** のプライベート IP を選択し、作成したインスタンスを選択して、ポートとして 80 を設定します。
   - **「追加」**をクリックし、今度は **vpc-region1-zone2-subnet** のプライベート IP を選択し、インスタンスを選択して、ポートに 80 を設定します。
   - **「接続」**をクリックして、バックエンド・プールの作成を完了します。
6. **「新規リスナー」**をクリックして、新規フロントエンド・リスナーを作成します。リスナーとは、接続要求の有無をチェックするプロセスのことです。
   - **プロトコル**: HTTP
   - **ポート**: 80
   - **バックエンド・プール**: region1-pool
   - **最大接続数 (Maxconnections)**: 空のままにして、**「作成」**をクリックします。
7. **「ロード・バランサーの作成 (Create load balancer)」**をクリックして、ロード・バランサーをプロビジョンします。

### ロード・バランサーをテストする

1. ロード・バランサーの状況が**「アクティブ」**に変わるまで待ちます。
2. Web ブラウザーで**アドレス**を開きます。
3. ページを何度か最新表示して、ロード・バランサーが最新表示ごとに別のサーバーにアクセスすることを確認します。
4. 今後参照するために、アドレスを**保存**します。

要求は暗号化されておらず、HTTP のみサポートされることが分かります。次のセクションで SSL 証明書を構成して HTTPS を有効にします。

**地域 2** で上記の 1 から 7 の手順を**繰り返します**。

## HTTPS を使用して VPC 内のトラフィックを保護する
{: #secure_https}

HTTPS リスナーを追加する前に、SSL 証明書を生成し、カスタム・ドメインの認証性を確認する必要があります。カスタム・ドメインとは、証明書を保持してインフラストラクチャー・サービスにマップする場所のことです。

### CIS サービスをプロビジョンして、カスタム・ドメインを構成する

このセクションでは、IBM Cloud Internet Services (CIS) サービスを作成し、CIS ネーム・サーバーを指すようにカスタム・ドメインを構成した後で、グローバル・ロード・バランサーを構成します。

1. {{site.data.keyword.Bluemix_notm}} カタログの [Internet Services](https://{DomainName}/catalog/services/internet-services) にナビゲートします。
2. サービス名を設定し、**「作成」**をクリックして、サービスのインスタンスを作成します。このチュートリアルでは、任意の料金プランを使用できます。
3. サービス・インスタンスがプロビジョンされたら、**「始める」**をクリックしてドメイン・ネームを設定し、**「ドメインの追加」**をクリックします。
4. **「次のステップ」**をクリックします。ネーム・サーバーが割り当てられたら、そのリストされたネーム・サーバーを使用するようにレジストラーまたはドメイン・ネーム・プロバイダーを構成します。 
5. レジストラーまたは DNS プロバイダーを構成してから、その変更が反映されるまでに最大で 24 時間かかる場合があります。

   「概要」ページのドメインの状況が*「保留中」*から*「アクティブ」*に変わったら、`dig <YOUR_DOMAIN_NAME> ns` コマンドを使用して、新しいネーム・サーバーが有効になったことを確認できます。
   {:tip}

グローバル・ロード・バランサーで使用する予定のドメインとサブドメインの SSL 証明書を入手する必要があります。mydomain.com のようなドメインがあるとすると、グローバル・ロード・バランサーは `lb.mydomain.com` でホストできます。lb.mydomain.com の証明書を発行する必要があります。

[Let's Encrypt](https://letsencrypt.org/) から無料の SSL 証明書を入手できます。このプロセス中に、ドメインの所有者であることを証明するために、Cloud Internet Services の DNS インターフェースに TXT タイプの DNS レコードを構成する必要がある場合があります。
{:tip}

ドメインの SSL 証明書と秘密鍵を取得したら、それらを [PEM](https://en.wikipedia.org/wiki/Privacy-Enhanced_Mail) フォーマットに必ず変換してください。

1. 証明書を PEM フォーマットに変換するには、次のようにします。
   ```
   openssl x509 -in domain-crt.txt -out domain-crt.pem -outform PEM
   ```
   {: pre}
2. 秘密鍵を PEM フォーマットに変換するには、次のようにします。
   ```
   openssl rsa -in domain-key.txt -out domain-key.pem -outform PEM
   ```
   {: pre}

### 証明書をインポートしてロード・バランサー・サービスを許可する

SSL 証明書は IBM Certificate Manager で管理できます。

1. サポートされている場所で [{{site.data.keyword.cloudcerts_short}}](https://{DomainName}/catalog/services/cloudcerts) インスタンスを作成します。
2. サービス・ダッシュボードで、**「証明書のインポート (Import Certificate)」**を次のように使用します。
   * **「名前」**をカスタムのサブドメインおよびドメイン (例えば、*lb.mydomain.com*) に設定します。
   * PEM フォーマットの**証明書ファイル**を参照します。
   * PEM フォーマットの**秘密鍵ファイル**を参照します。
   * **「インポート」**を実行します。
3. SSL 証明書が含まれる証明書マネージャー・インスタンスにロード・バランサー・サービス・インスタンスがアクセスできるようにする許可を作成します。このような許可は、[ID およびアクセス許可](https://{DomainName}/iam#/authorizations)を使用して管理できます。
  - **「作成」**をクリックして、ソース・サービスとして**「インフラストラクチャー・サービス」**を選択します。
  - リソース・タイプとして**「Load Balancer for VPC」**を選択します。
  - ターゲット・サービスとして**「Certificate Manager」**を選択します。
  - **「ライター」**のサービス・アクセス役割を割り当てます。
  - ロード・バランサーを作成するには、ソース・リソース・インスタンスに対して「すべてのリソース・インスタンス」許可を付与する必要があります。ターゲット・サービス・インスタンスは**「すべてのインスタンス」**の場合もあれば、特定の証明書マネージャー・リソース・インスタンスの場合もあります。

### HTTPS リスナーを作成する

ここで、[ロード・バランサー](https://{DomainName}/vpc/network/loadBalancers)に移動します。

1. **vpc-lb-region1** を選択します。
2. **「フロントエンド・リスナー」**で、**「新規リスナー」**をクリックします。

   -  **プロトコル**: HTTPS
   -  **ポート**: 443
   -  **バックエンド・プール**: 同一地域内のプール
   -  **lb.YOUR-DOMAIN-NAME** の SSL 証明書を選択します。

3. **「作成」**をクリックして、HTTPS リスナーを構成します。

**地域 2** のロード・バランサーで同じ手順を**繰り返します**。

## グローバル・ロード・バランサーを構成する
{: #global-load-balancer}

このセクションでは、さまざまな {{site.data.keyword.Bluemix_notm}} 地域に構成されているローカル・ロード・バランサーに着信トラフィックを分散するグローバル・ロード・バランサー (GLB) を構成します。

### グローバル・ロード・バランサーを使用して複数の地域にトラフィックを分散する
サービスの下の[「リソース・リスト」](https://{DomainName}/resources)に移動して、作成した CIS サービスを開きます。

1. **「信頼性」**の下の**「グローバル・ロード・バランサー」**に移動して、**「ロード・バランサーの作成」**をクリックします。
2. ホスト名として **lb.YOUR-DOMAIN-NAME** と入力し、TTL を 60 秒に設定します。
3. **「プールの追加」**をクリックして、デフォルトの起点プールを定義します。
   - **名前**: lb-region1
   - **ヘルス・チェック**: 新規ヘルス・チェックを作成します。
     - **モニター・タイプ**: HTTP
     - **パス**: /
     - **ポート**: 80
   - **ヘルス・チェック地域**: 北アメリカ東部
   - **起点**
     - **名前**: region1
     - **アドレス**: **REGION1** のローカル・ロード・バランサーのアドレス
     - **重み**: 1
     - **「追加」**をクリックします。

4. **「西ヨーロッパ」**地域の **region2** ロード・バランサーを指す**起点プール**をもう 1 つ**追加**して、**「1 件のリソースのプロビジョン」**をクリックして、グローバル・ロード・バランサーをプロビジョンします。

**ヘルス**・チェックの状況が**「正常」**に変わるまで待ちます。任意のブラウザーで **lb.YOUR-DOMAIN-NAME** リンクを開き、稼働中のグローバル・ロード・バランサーを表示します。

### フェイルオーバー・テスト
ここまでで、**地域 1** のサーバーは**地域 2** のサーバーと比べて高い重みが割り当てられているために、ほとんどの場合に、地域 1 のサーバーにアクセスすることが分かったはずです。ここで、**地域 1** の起点プールにヘルス・チェックの失敗が発生したとしましょう。

1. [仮想サーバー・インスタンス](https://{DomainName}/vpc/compute/vs)に移動します。
2. **地域 1** の**ゾーン 1** で実行されているサーバーの横の **3 つのドット (...)** をクリックして、**「停止」**をクリックします。
3. **地域 1** の**ゾーン 2** で実行されているサーバーに対して同じ手順を**繰り返します**。
4. CIS サービスの下の GLB に戻り、正常性の状況が**「重大」**に変わるまで待ちます。
5. これで、ドメインの URL を最新表示すると、常に**地域 2** のサーバーにアクセスするはずです。

地域 1 のゾーン 1 とゾーン 2 のサーバーを必ず**始動**してください。
{:tip}

## リソースの削除
{: #removeresources}

- CIS サービスの下のグローバル・ロード・バランサー、起点プール、およびヘルス・チェックを削除します。
- 証明書マネージャー・サービスの証明書を削除します。
- ロード・バランサー、VSI、サブネット、および VPC を削除します。
- [リソース・リスト](https://{DomainName}/resources)で、このチュートリアルで使用したサービスを削除します。


## 関連コンテンツ
{: #related}

* [IBM Cloud VPC でのロード・バランサーの使用](/docs/infrastructure/vpc-network?topic=vpc-network---beta-using-load-balancers-in-ibm-cloud-vpc#--beta-using-load-balancers-in-ibm-cloud-vpc)
